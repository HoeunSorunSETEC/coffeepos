{% extends 'layouts/base.html' %} {% block title %}Products - Coffee Shop POS{%
endblock %} {% block content %}
<div class="row">
  <!-- Product Display Section -->
  <div class="col-lg-9">
    <!-- Header Tabs -->
    <ul class="nav nav-pills mb-4">
      <li class="nav-item">
        <button class="nav-link text-uppercase" onclick="filterCategory('all')">
          All
        </button>
      </li>
      {% for category in categories %}
      <li class="nav-item">
        <button
          class="nav-link text-uppercase"
          onclick="filterCategory('{{ category }}')"
        >
          {{ category }}
        </button>
      </li>
      {% endfor %}
    </ul>

    <!-- Product Grid -->
    <div class="row" id="product-grid">
      {% for category, products in categorized_products.items() %} {% for
      product in products %}
      <div
        class="col-sm-6 col-md-4 col-lg-3 product-item"
        data-category="{{ category }}"
      >
        <div class="card shadow-sm">
          <img
            src="{{ url_for('static', filename='images/' ~ product.image) }}"
            class="card-img-top img-fluid"
            alt="{{ product.name }}"
          />
          <div class="card-body text-center">
            <h5 class="card-title text-dark">{{ product.name }}</h5>
            <p class="card-text text-muted">${{ product.price }}</p>
            <button
              class="btn btn-primary btn-sm w-100"
              onclick="askSugarPercentage('{{ product.id }}', '{{ product.name }}', {{ product.price }})"
            >
              Add to Order
            </button>
          </div>
        </div>
      </div>
      {% endfor %} {% endfor %}
    </div>
  </div>

  <!-- Order Summary Section -->
  <div
    class="col-lg-3 bg-white shadow p-4 border-start"
    style="height: 100vh; overflow-y: auto"
  >
    <h5 class="text-center mb-4">Order Summary</h5>
    <div id="order-list" class="mb-4" style="max-height: 60%; overflow-y: auto">
      <!-- Dynamically added items -->
    </div>
    <div class="border-top pt-3">
      <p class="d-flex justify-content-between">
        <span>Subtotal:</span>
        <span id="subtotal">$0.00</span>
      </p>
      <p class="d-flex justify-content-between">
        <span>Tax (10%):</span>
        <span id="tax">$0.00</span>
      </p>
      <p class="fw-bold d-flex justify-content-between">
        <span>Total:</span>
        <span id="total">$0.00</span>
      </p>
    </div>
    <button class="btn btn-success w-100 mt-3" onclick="proceedOrder()">
      Proceed
    </button>
  </div>
</div>

<!-- Modal for Sugar Percentage -->
<div
  class="modal fade"
  id="sugarPercentageModal"
  tabindex="-1"
  aria-labelledby="sugarPercentageModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sugarPercentageModalLabel">
          Select Sugar Percentage
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="sugarPercentageForm">
          <div class="mb-3">
            <label for="sugar-percentage" class="form-label"
              >Sugar Percentage</label
            >
            <select class="form-select" id="sugar-percentage" required>
              <option value="">Choose...</option>
              <option value="0%">0%</option>
              <option value="25%">25%</option>
              <option value="50%">50%</option>
              <option value="75%">75%</option>
              <option value="100%">100%</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            Add to Order
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let orderList = [];
  let subtotal = 0;
  let selectedProduct = null;

  function askSugarPercentage(productId, productName, productPrice) {
    selectedProduct = { id: productId, name: productName, price: productPrice };
    const modal = new bootstrap.Modal(
      document.getElementById("sugarPercentageModal")
    );
    modal.show();
  }

  document
    .getElementById("sugarPercentageForm")
    .addEventListener("submit", function (event) {
      event.preventDefault();
      const sugarPercentage = document.getElementById("sugar-percentage").value;
      if (!sugarPercentage) return;

      addToOrder(
        selectedProduct.id,
        selectedProduct.name,
        selectedProduct.price,
        sugarPercentage
      );

      // Close the modal
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("sugarPercentageModal")
      );
      modal.hide();
    });

  function addToOrder(productId, productName, productPrice, sugarPercentage) {
    orderList.push({
      id: productId,
      name: productName,
      price: productPrice,
      sugarPercentage: sugarPercentage,
    });
    subtotal += productPrice;
    renderOrderList();
  }

  function renderOrderList() {
    const orderListElement = document.getElementById("order-list");
    orderListElement.innerHTML = "";

    orderList.forEach((item) => {
      const orderItem = document.createElement("div");
      orderItem.className = "d-flex justify-content-between mb-2";
      orderItem.innerHTML = `
        <div>
          <strong>${item.name}</strong><br />
          <small>Sugar: ${item.sugarPercentage}</small>
        </div>
        <span>$${item.price.toFixed(2)}</span>
      `;
      orderListElement.appendChild(orderItem);
    });

    const tax = subtotal * 0.1;
    const total = subtotal + tax;

    document.getElementById("subtotal").innerText = `$${subtotal.toFixed(2)}`;
    document.getElementById("tax").innerText = `$${tax.toFixed(2)}`;
    document.getElementById("total").innerText = `$${total.toFixed(2)}`;
  }

  async function proceedOrder() {
    if (orderList.length === 0) {
      alert("No items in the order.");
      return;
    }

    const payload = {
      items: orderList.map((item) => ({
        product_id: item.id,
        sugar_level: item.sugarPercentage,
        quantity: 1, // Set quantity to 1 for simplicity; adjust as needed
        price: item.price,
      })),
    };

    try {
      const response = await fetch("/api/orders", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        const result = await response.json();
        alert(`Order placed successfully! Order ID: ${result.order_id}`);
        // Reset the order
        orderList = [];
        subtotal = 0;
        renderOrderList();
      } else {
        const error = await response.json();
        alert(`Error: ${error.error}`);
      }
    } catch (error) {
      console.error("Error submitting order:", error);
      alert("An error occurred while placing the order.");
    }
  }

  function filterCategory(category) {
    const productItems = document.querySelectorAll(".product-item");

    if (category === "all") {
      productItems.forEach((item) => (item.style.display = "block"));
    } else {
      productItems.forEach((item) => {
        item.style.display =
          item.dataset.category === category ? "block" : "none";
      });
    }
  }
</script>
{% endblock %}
